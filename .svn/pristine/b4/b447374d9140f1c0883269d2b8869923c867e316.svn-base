package client.potlach.com.potlachandroid.activity;

import android.content.Intent;
import android.os.AsyncTask;
import android.os.Bundle;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ListView;

import java.util.Iterator;
import java.util.List;
import java.util.concurrent.ExecutionException;

import butterknife.ButterKnife;
import butterknife.InjectView;
import client.potlach.com.potlachandroid.R;
import client.potlach.com.potlachandroid.model.Chain;
import client.potlach.com.potlachandroid.model.Gift;
import client.potlach.com.potlachandroid.service.GiftSvc;
import client.potlach.com.potlachandroid.service.GiftSvcApi;
import client.potlach.com.potlachandroid.singleton.DataHolder;
import client.potlach.com.potlachandroid.util.GiftListAdapter;
import client.potlach.com.potlachandroid.widget.EndlessScrollListener;


public class GiftListActivity extends BaseActivity{

    private static final String TAG = "GiftListActivity";

    private Chain currentChain;
    @InjectView(R.id.giftListView)
    protected ListView giftListView;
    private GiftSvcApi giftSvc;
    Long giftCount = 0l;
    List<Gift> gifts = null;
    String searchTitle;

    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_gift_list);
        ButterKnife.inject(this);
        currentChain = DataHolder.getInstance().getCurrentChain();
        giftSvc = GiftSvc.getOrShowLogin(this);
        Bundle extras = getIntent().getExtras();
        if(extras!=null && extras.containsKey(HomeActivity.SEARCH_TITLE)){
            searchTitle = extras.getString(HomeActivity.SEARCH_TITLE);
            setActionBarTitle(searchTitle.toUpperCase(), true);
            loadGiftFromSearchTitle("0");
        }else if(currentChain!=null){
            searchTitle=null;
            setActionBarTitle(currentChain.getName(), true);
            loadGiftsFromCurrentChain(0l);
        }
        initGiftListView();

        //Load chain from asyncTask, pass gifts from chain to
        //adapter.
    }


    private void loadGiftFromSearchTitle(String page) {
        //TODO refactor this code to fetch gifts and count by title
        try {
            if(giftCount==0){
                giftCount = new CountGiftsByTitleTask().execute(searchTitle).get();
            }
            gifts = new LoadGiftsByTitleAndPage().execute(searchTitle,page).get();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        }
    }

    private void loadGiftsFromCurrentChain(Long page) {
        currentChain.setGifts(null);
        if(currentChain.getGifts()==null){
            try {
                if(giftCount==0)
                    giftCount = new CountGiftsByChainIdTask().execute(currentChain.getId()).get();
                gifts = new LoadGiftsByChainIdAndPage().execute(currentChain.getId(), page).get();
            } catch (InterruptedException e) {
                e.printStackTrace();
            } catch (ExecutionException e) {
                e.printStackTrace();
            }

        }else{
            gifts = currentChain.getGifts();
            giftCount = Long.parseLong(Integer.toString(gifts.size())) ;
        }
    }

    private void initGiftListView() {
        if(giftCount > 0) {
            final GiftListAdapter adapter = new GiftListAdapter(this, gifts);
            adapter.setServerListSize(Integer.parseInt(giftCount.toString()));
            giftListView.setOnItemClickListener(new AdapterView.OnItemClickListener() {

                @Override
                public void onItemClick(AdapterView<?> parent, View view, int position, long arg3) {

                    Gift g = adapter.getDataList().get(position);

                }
            });
            giftListView.setAdapter(adapter);
            final Long finalGiftCount = giftCount;
            giftListView.setOnScrollListener(new EndlessScrollListener(1, 0) {
                @Override
                public void onLoadMore(int page, int totalItemsCount) {
                    if(totalItemsCount-1 < finalGiftCount){
//                        Log.d(TAG, "Loading more items, page: "+page+" totalItems: "+totalItemsCount);
//                        Log.d(TAG, "CurrentChainId: "+currentChain.getId());
                        if(searchTitle!=null)
                            loadGiftFromSearchTitle(searchTitle);
                        else
                            loadGiftsFromCurrentChain(Long.parseLong(Integer.toString(page)));
                        if(gifts!=null){
                            adapter.getDataList().addAll(gifts);
                            adapter.notifyDataSetChanged();
                        }
                        /*List<Gift> result = new LoadGiftsByChainIdAndPage().execute(currentChain.getId(), Long.parseLong(Integer.toString(page))).get();
                        if(result!=null){
                            adapter.getDataList().addAll(result);
                            adapter.notifyDataSetChanged();
                        }*/
                    }
                }
            });
        }
    }


    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.gift_list, menu);
        return true;
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
        int id = item.getItemId();
        switch (id){
            case R.id.action_new_gift:
                Intent i = new Intent(this, PostGiftActivity.class);
                if(currentChain!=null)
                    i.putExtra("chainName",currentChain.getName());
                startActivity(i);
                finish();
                return true;
            case android.R.id.home:
                finish();
                return true;
        }
        return super.onOptionsItemSelected(item);
    }

    class LoadGiftsByChainIdAndPage extends AsyncTask<Long,Integer,List<Gift>>{

        @Override
        protected List<Gift> doInBackground(Long... params) {
//            Log.d(TAG,params[0].toString() + "  "+params[1].toString());
            Long chainId = params[0];
            Integer page = Integer.parseInt(params[1].toString());
//            Log.d(TAG,chainId + "  "+page);
            return giftSvc.findByChainIdAndPageAndObscene(chainId,page, app.isObsceneEnabled());
        }
    }

    class LoadGiftsByTitleAndPage extends AsyncTask<String,Integer,List<Gift>>{

        @Override
        protected List<Gift> doInBackground(String... params) {
            Integer page = Integer.parseInt(params[1]);
            return giftSvc.findByTitleAndObsceneFlagAndPage(params[0], app.isObsceneEnabled(),page);
        }
    }

    class CountGiftsByChainIdTask extends AsyncTask<Long,Void,Long>{

        @Override
        protected Long doInBackground(Long... params) {
                return giftSvc.countByChainIdAndObscene(params[0], app.isObsceneEnabled());
        }
    }

    class CountGiftsByTitleTask extends AsyncTask<String,Void,Long>{

        @Override
        protected Long doInBackground(String... params) {
            return giftSvc.countByGiftTitleAndObscene(params[0],app.isObsceneEnabled());
        }
    }
}
